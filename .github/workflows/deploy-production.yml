name: ğŸŒŸ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-production:
    name: ğŸš€ Deploy to Production Environment
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ” Type check
        run: npm run type-check
        
      - name: ğŸ¨ Check formatting
        run: npm run format:check
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ğŸ§ª Run E2E tests
        run: npm run test:ci
        
      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: production-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30
          
      # Aqui vocÃª pode adicionar o deploy real para seu ambiente de produÃ§Ã£o
      # Exemplo com Vercel:
      # - name: ğŸš€ Deploy to Vercel Production
      #   uses: amondnet/vercel-action@v25
      #   with:
      #     vercel-token: ${{ secrets.VERCEL_TOKEN }}
      #     vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
      #     vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
      #     vercel-args: '--prod'
      #     scope: ${{ secrets.VERCEL_ORG_ID }}
      
      - name: ğŸ·ï¸ Create Release Tag
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;
            const date = new Date().toISOString().split('T')[0];
            const tagName = `v${date}-${sha.substring(0, 7)}`;
            
            try {
              await github.rest.git.createRef({
                owner,
                repo,
                ref: `refs/tags/${tagName}`,
                sha: sha
              });
              
              console.log(`Created tag: ${tagName}`);
            } catch (error) {
              console.log('Tag creation failed:', error.message);
            }
      
      - name: ğŸ“¢ Notify Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;
            
            // Cria uma issue de notificaÃ§Ã£o de deploy bem-sucedido
            await github.rest.issues.create({
              owner,
              repo,
              title: `ğŸš€ Production Deploy Successful - ${new Date().toISOString().split('T')[0]}`,
              body: `## âœ… Deploy to Production Completed Successfully!
              
              **Details:**
              - ğŸ• **Time:** ${new Date().toISOString()}
              - ğŸ“ **Commit:** ${sha.substring(0, 7)}
              - ğŸŒ **Environment:** Production
              - ğŸ”— **URL:** [View Live Site](https://your-production-url.com)
              
              **Checks Passed:**
              - âœ… TypeScript compilation
              - âœ… Code formatting
              - âœ… Build process
              - âœ… E2E tests
              
              This issue will be automatically closed in 24 hours.`,
              labels: ['deployment', 'production', 'success']
            });
      
      - name: ğŸš¨ Notify Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;
            
            await github.rest.issues.create({
              owner,
              repo,
              title: `ğŸš¨ Production Deploy Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## âŒ Production Deploy Failed!
              
              **Details:**
              - ğŸ• **Time:** ${new Date().toISOString()}
              - ğŸ“ **Commit:** ${sha.substring(0, 7)}
              - ğŸŒ **Environment:** Production
              - ğŸ”— **Workflow:** [View Failed Run](https://github.com/${owner}/${repo}/actions/runs/${context.runId})
              
              **Action Required:**
              - ğŸ” Check the workflow logs
              - ğŸ› Fix any issues found
              - ğŸ”„ Re-run the deployment
              
              **Priority:** HIGH - Production deployment failure!`,
              labels: ['deployment', 'production', 'failure', 'urgent'],
              assignees: ['devguimaraes']
            });